# Staging Environment Setup Guide

## Environment Details
- **App Service**: `app-steel-estimation-prod` (Staging Slot: `/staging`)
- **Database**: `sqldb-steel-estimation-sandbox`
- **Server**: `nwiapps.database.windows.net`
- **URL**: https://app-steel-estimation-prod-staging.azurewebsites.net

## Database Setup

### Option 1: Apply Migrations Locally (Recommended)
```powershell
# Generate SQL script only (safest option)
.\apply-migrations-to-staging-sandbox.ps1 -GenerateScriptOnly

# Or apply directly with SQL auth
.\apply-migrations-to-staging-sandbox.ps1 -UseLocalConnection
```

### Option 2: Manual SQL Execution
1. Run these SQL scripts in order on `sqldb-steel-estimation-sandbox`:
   - `migration-script.sql` (generated by EF)
   - `create-admin-user.sql` (if admin user needed)
   - `grant-staging-access.sql` (for Managed Identity)

### Verify Database Setup
```powershell
# Check database state
.\verify-staging-database.ps1 -SqlUsername "sqladmin"
```

## Authentication Configuration

### Session-Based Authentication (Active)
- **Provider**: `CustomAuthenticationStateProvider`
- **Storage**: `ProtectedSessionStorage`
- **Timeout**: 8 hours
- **Test Credentials**: 
  - Email: `admin@steelestimation.com`
  - Password: `Admin@123`

### JWT Configuration (Not Used)
- JWT settings in `appsettings.Staging.json` are ignored
- Authentication is purely session-based
- No token refresh needed

## Deployment

### Deploy with Migrations
```powershell
# Deploy and run migrations
.\deploy-staging-with-migrations.ps1

# Deploy without migrations (if already applied)
.\deploy-staging-with-migrations.ps1 -SkipMigrations

# Deploy with SQL auth for migrations
.\deploy-staging-with-migrations.ps1 -UseSqlAuth
```

### Quick Redeploy
```powershell
# Redeploy without rebuilding
.\redeploy-staging.ps1
```

## Testing Endpoints

1. **Home Page**: https://app-steel-estimation-prod-staging.azurewebsites.net
2. **Database Test**: https://app-steel-estimation-prod-staging.azurewebsites.net/dbtest
3. **Auth Test**: https://app-steel-estimation-prod-staging.azurewebsites.net/authtest
4. **Login Page**: https://app-steel-estimation-prod-staging.azurewebsites.net/login

## Troubleshooting

### Database Connection Issues
1. Check Managed Identity permissions:
   ```sql
   SELECT name, type_desc 
   FROM sys.database_principals 
   WHERE name = 'app-steel-estimation-prod/slots/staging'
   ```

2. Verify connection string in App Service Configuration
3. Check Azure SQL firewall rules

### Authentication Issues
1. Clear browser cache/cookies
2. Check session storage in browser DevTools
3. Verify admin user exists in database
4. Check Log Stream in Azure Portal

### Migration Issues
1. Generate SQL script and run manually
2. Use SQL authentication instead of Managed Identity
3. Check if staging slot has `db_ddladmin` permissions
4. Review migration history table: `__EFMigrationsHistory`

## Important Notes

1. **Program.cs Changes**: Staging now runs migrations automatically on startup
2. **Decimal Precision**: Fixed for `ContingencyPercentage`, `LaborRate`, and `WeldLength`
3. **Seed Data**: 5 default roles are created by migrations
4. **No JWT**: Despite configuration, JWT is not used in staging

## Quick Commands Reference

```powershell
# Generate new migration
.\create-ef-migration.ps1

# Apply to staging
.\apply-migrations-to-staging-sandbox.ps1 -GenerateScriptOnly

# Deploy to staging
.\deploy-staging-with-migrations.ps1

# Test configuration
.\test-staging-config.ps1

# View logs
az webapp log tail --name app-steel-estimation-prod --slot staging --resource-group NWIApps
```