@page "/profile/{Username?}"
@using Microsoft.AspNetCore.Authorization
@using SteelEstimation.Core.Interfaces
@using SteelEstimation.Core.Entities
@using SteelEstimation.Core.DTOs
@using System.Security.Claims
@attribute [Authorize]
@inject IUserProfileService ProfileService
@inject IUserService UserService
@inject IFabOSAuthenticationService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="container-fluid mt-4">
    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (profile == null)
    {
        <div class="alert alert-warning">
            <h4>Profile Not Found</h4>
            <p>The requested user profile could not be found.</p>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Profile Header -->
            <div class="col-12">
                <div class="card profile-header mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="avatar-container">
                                    @if (!string.IsNullOrEmpty(profile.DiceBearStyle))
                                    {
                                        var options = new Dictionary<string, object>();
                                        if (!string.IsNullOrEmpty(profile.DiceBearOptions))
                                        {
                                            try
                                            {
                                                options = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, object>>(profile.DiceBearOptions) ?? new Dictionary<string, object>();
                                            }
                                            catch { }
                                        }
                                        var avatarUrl = SteelEstimation.Web.Data.DiceBearAvatars.GenerateAvatarUrl(
                                            profile.DiceBearStyle, 
                                            profile.DiceBearSeed ?? "default", 
                                            "svg",
                                            options
                                        );
                                        <img src="@avatarUrl" alt="@user.FullName" class="avatar-large dicebear-avatar" />
                                    }
                                    else
                                    {
                                        <div class="avatar-placeholder avatar-large">
                                            <span>@GetInitials(user.FullName)</span>
                                        </div>
                                    }
                                    @if (isOwnProfile)
                                    {
                                        <button class="btn btn-sm btn-primary avatar-change-btn" @onclick="EditProfile">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                            <div class="col">
                                <h2 class="mb-1">@user.FullName</h2>
                                <p class="text-muted mb-2">@@@@user.Username</p>
                                @if (!string.IsNullOrEmpty(profile.JobTitle))
                                {
                                    <p class="mb-1"><i class="fas fa-briefcase me-2"></i>@profile.JobTitle</p>
                                }
                                @if (!string.IsNullOrEmpty(profile.Department))
                                {
                                    <p class="mb-1"><i class="fas fa-building me-2"></i>@profile.Department</p>
                                }
                                @if (!string.IsNullOrEmpty(profile.Location))
                                {
                                    <p class="mb-1"><i class="fas fa-map-marker-alt me-2"></i>@profile.Location</p>
                                }
                                <div class="mt-2">
                                    @if (!string.IsNullOrEmpty(profile.Status))
                                    {
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-circle me-1"></i>@profile.Status
                                        </span>
                                    }
                                    @if (profile.LastActivityAt.HasValue)
                                    {
                                        <small class="text-muted">
                                            Last active @GetTimeAgo(profile.LastActivityAt.Value)
                                        </small>
                                    }
                                </div>
                            </div>
                            <div class="col-auto">
                                @if (isOwnProfile)
                                {
                                    <button class="btn btn-primary" @onclick="EditProfile">
                                        <i class="fas fa-edit me-2"></i>Edit Profile
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="col-lg-4">
                <!-- About Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">About</h5>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(profile.Bio))
                        {
                            <p>@profile.Bio</p>
                        }
                        else if (isOwnProfile)
                        {
                            <p class="text-muted">Add a bio to tell others about yourself.</p>
                        }
                        
                        <hr />
                        
                        <div class="profile-details">
                            @if (profile.ShowEmail || isOwnProfile)
                            {
                                <div class="mb-2">
                                    <i class="fas fa-envelope me-2"></i>
                                    <a href="mailto:@user.Email">@user.Email</a>
                                </div>
                            }
                            @if ((profile.ShowPhoneNumber || isOwnProfile) && !string.IsNullOrEmpty(profile.PhoneNumber))
                            {
                                <div class="mb-2">
                                    <i class="fas fa-phone me-2"></i>
                                    <a href="tel:@profile.PhoneNumber">@profile.PhoneNumber</a>
                                </div>
                            }
                            @if (profile.StartDate.HasValue)
                            {
                                <div class="mb-2">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Joined @profile.StartDate.Value.ToString("MMMM yyyy")
                                </div>
                            }
                            <div class="mb-2">
                                <i class="fas fa-building me-2"></i>
                                @user.CompanyName
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills Card -->
                @if (!string.IsNullOrEmpty(profile.Skills))
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Skills</h5>
                        </div>
                        <div class="card-body">
                            <div class="skill-tags">
                                @foreach (var skill in profile.Skills.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                {
                                    <span class="badge bg-primary me-2 mb-2">@skill.Trim()</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Activity Feed -->
            <div class="col-lg-8">
                <UserActivityFeed UserId="@user.Id" ShowComments="true" />
            </div>
        </div>

        <!-- Edit Profile Modal -->
        @if (showEditModal)
        {
            <div class="modal fade show" style="display: block;" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Profile</h5>
                            <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                        </div>
                        <div class="modal-body">
                            <EditForm Model="editModel" OnValidSubmit="SaveProfile">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <!-- Enhanced Avatar Selection -->
                                <div class="mb-4">
                                    <EnhancedAvatarSelectorV2 
                                        SelectedAvatarType="dicebear"
                                        SelectedDiceBearStyle="@editModel.DiceBearStyle"
                                        SelectedDiceBearSeed="@editModel.DiceBearSeed"
                                        SelectedDiceBearOptions="@editModel.DiceBearOptions"
                                        OnAvatarSelected="HandleAvatarSelection" />
                                </div>

                                <hr class="my-4" />

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Job Title</label>
                                            <InputText @bind-Value="editModel.JobTitle" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Department</label>
                                            <InputText @bind-Value="editModel.Department" class="form-control" />
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Bio</label>
                                    <InputTextArea @bind-Value="editModel.Bio" class="form-control" rows="3" />
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Location</label>
                                            <InputText @bind-Value="editModel.Location" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Phone Number</label>
                                            <InputText @bind-Value="editModel.PhoneNumber" class="form-control" />
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Skills (comma-separated)</label>
                                    <InputText @bind-Value="editModel.Skills" class="form-control" 
                                             placeholder="e.g., Welding, Steel Fabrication, Project Management" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">About Me</label>
                                    <InputTextArea @bind-Value="editModel.AboutMe" class="form-control" rows="4" />
                                </div>

                                <hr />

                                <h6>Privacy Settings</h6>
                                <div class="form-check mb-2">
                                    <InputCheckbox @bind-Value="editModel.IsProfilePublic" class="form-check-input" id="publicProfile" />
                                    <label class="form-check-label" for="publicProfile">
                                        Make my profile public
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <InputCheckbox @bind-Value="editModel.ShowEmail" class="form-check-input" id="showEmail" />
                                    <label class="form-check-label" for="showEmail">
                                        Show my email address
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <InputCheckbox @bind-Value="editModel.ShowPhoneNumber" class="form-check-input" id="showPhone" />
                                    <label class="form-check-label" for="showPhone">
                                        Show my phone number
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <InputCheckbox @bind-Value="editModel.AllowMentions" class="form-check-input" id="allowMentions" />
                                    <label class="form-check-label" for="allowMentions">
                                        Allow others to mention me
                                    </label>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                        @if (isSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        Save Changes
                                    </button>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-backdrop fade show"></div>
        }
    }
</div>

<style>
    .profile-header {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    .avatar-container {
        position: relative;
        display: inline-block;
    }

    .avatar-large {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .dicebear-avatar {
        background: #f8f9fa;
    }

    .avatar-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        font-weight: bold;
        border: 4px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .avatar-upload-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .skill-tags {
        display: flex;
        flex-wrap: wrap;
    }

    .profile-details i {
        width: 20px;
        color: #6c757d;
    }

    .avatar-icon-container {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3.5rem;
        color: #495057;
        background: #f8f9fa;
        border: 4px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .avatar-icon-container.avatar-large {
        width: 120px;
        height: 120px;
        border-radius: 50%;
    }

    .avatar-icon-container i {
        font-size: 3.5rem;
    }

    .avatar-change-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Avatar Selector Styles */
    .avatar-selector {
        max-width: 600px;
    }

    .avatar-preview {
        display: inline-block;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid #dee2e6;
    }

    .avatar-icon-large {
        font-size: 5rem;
        color: #495057;
    }

    .avatar-category {
        margin-bottom: 2rem;
    }

    .avatar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
    }

    .avatar-option {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .avatar-option i {
        font-size: 2.5rem;
        color: #6c757d;
        transition: color 0.2s ease;
    }

    .avatar-option:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        transform: translateY(-2px);
    }

    .avatar-option:hover i {
        color: #495057;
    }

    .avatar-option.selected {
        background: #0d1a80;
        border-color: #0d1a80;
    }

    .avatar-option.selected i {
        color: white;
    }

    @@media (max-width: 576px) {
        .avatar-grid {
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        }

        .avatar-option {
            width: 60px;
            height: 60px;
        }

        .avatar-option i {
            font-size: 1.8rem;
        }
    }
</style>

@code {
    [Parameter] public string? Username { get; set; }

    private User? user;
    private SteelEstimation.Core.Entities.UserProfile? profile;
    private int currentUserId;
    private bool isOwnProfile;
    private bool isLoading = true;
    private bool showEditModal;
    private bool isSaving;

    private UpdateUserProfileRequest editModel = new();

    protected override async Task OnInitializedAsync()
    {
        currentUserId = await AuthService.GetCurrentUserIdAsync() ?? 0;
        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        isLoading = true;

        try
        {
            if (string.IsNullOrEmpty(Username))
            {
                // Load current user's profile
                user = await AuthService.GetCurrentUserAsync();
                isOwnProfile = true;
            }
            else
            {
                // Load specified user's profile
                user = await UserService.GetUserByUsernameAsync(Username);
                isOwnProfile = user?.Id == currentUserId;
            }

            if (user != null)
            {
                profile = await ProfileService.GetUserProfileAsync(user.Id);
                
                // Create profile if it doesn't exist for current user
                if (profile == null && isOwnProfile)
                {
                    profile = await ProfileService.CreateUserProfileAsync(user.Id, new CreateUserProfileRequest());
                }
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private void EditProfile()
    {
        if (profile != null)
        {
            editModel = new UpdateUserProfileRequest
            {
                AvatarUrl = profile.AvatarUrl,
                AvatarType = "dicebear",
                DiceBearStyle = profile.DiceBearStyle,
                DiceBearSeed = profile.DiceBearSeed,
                JobTitle = profile.JobTitle,
                Department = profile.Department,
                Bio = profile.Bio,
                Location = profile.Location,
                PhoneNumber = profile.PhoneNumber,
                Skills = profile.Skills,
                AboutMe = profile.AboutMe,
                IsProfilePublic = profile.IsProfilePublic,
                ShowEmail = profile.ShowEmail,
                ShowPhoneNumber = profile.ShowPhoneNumber,
                AllowMentions = profile.AllowMentions,
                Status = profile.Status,
                StatusMessage = profile.StatusMessage
            };
        }
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
    }

    private async Task SaveProfile()
    {
        if (user == null) return;

        isSaving = true;
        try
        {
            profile = await ProfileService.UpdateUserProfileAsync(user.Id, editModel);
            showEditModal = false;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task UploadAvatar()
    {
        // TODO: Implement file upload dialog
        await JSRuntime.InvokeVoidAsync("alert", "Avatar upload coming soon!");
    }

    private string GetInitials(string fullName)
    {
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        else if (parts.Length == 1)
            return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
        return "U";
    }

    private void HandleAvatarSelection(SteelEstimation.Web.Components.EnhancedAvatarSelectorV2.AvatarSelectionData data)
    {
        editModel.AvatarType = "dicebear";
        editModel.DiceBearStyle = data.DiceBearStyle;
        editModel.DiceBearSeed = data.DiceBearSeed;
        editModel.DiceBearOptions = data.DiceBearOptions;
        
        StateHasChanged();
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        
        return dateTime.ToString("MMM d, yyyy");
    }
}